# =====================================================
# 🔹 Etapa 1: Construcción con Maven
# =====================================================
FROM maven:3.9.6-eclipse-temurin-17 AS builder

WORKDIR /app

# Copiar pom y descargar dependencias
COPY pom.xml .
RUN mvn dependency:go-offline -B

# Copiar el código fuente
COPY src ./src

# Compilar y empaquetar (sin tests)
RUN mvn clean package -DskipTests

# =====================================================
# 🔹 Etapa 2: Imagen final (runtime)
# =====================================================
FROM eclipse-temurin:17-jre

LABEL maintainer="Daniel Arcos <darcos@banred.fin.ec>"
LABEL description="Microservicio de firma y cifrado - ms-middleware-signcrypt"

WORKDIR /app

# Crear directorios de configuración y logs
RUN mkdir -p /logs /etc/tls/config /etc/tls/certs/ca/crl /etc/tls/rsa-keys /etc/tls/keystore

# Copiar el .jar desde la etapa anterior
COPY --from=builder /app/target/*.jar /app/ms-middleware-signcrypt.jar

# Copiar certificados si están disponibles (montados por volumen en Compose o K8s)
# COPY ./tls /etc/tls/

# Puerto de la aplicación
EXPOSE 8442

# Variables de entorno
ENV SERVER_PORT=8442 \
    SPRING_PROFILES_ACTIVE=prod \
    REDIS_HOSTNAME=redis \
    REDIS_PORT=6379 \
    ELASTICSEARCH_HOST=elasticsearch:9200 \
    JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseContainerSupport"

# Comando de inicio
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/ms-middleware-signcrypt.jar"]
